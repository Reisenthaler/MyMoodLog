name: Build Android Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write   # allow creating releases

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION }}
          cache: "npm"

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci


      # 3.5 Inject build metadata
      - name: Inject build info
        run: |
          git fetch --tags

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            # Built from a tag (release)
            VERSION="${GITHUB_REF_NAME#v}"
          else
            # Built from a branch (between versions)
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
            LAST_TAG="${LAST_TAG#v}"
            COMMIT_SHA=$(git rev-parse --short HEAD)
            VERSION="${LAST_TAG}+dev.${COMMIT_SHA}"
          fi

          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_SHA=$(git rev-parse --short HEAD)

          cat <<EOF > src/environments/build-info.ts
          export const BUILD_INFO = {
            version: "$VERSION",
            buildDate: "$BUILD_DATE",
            commit: "$COMMIT_SHA",
          };
          EOF

          echo "Build info injected:"
          cat src/environments/build-info.ts

      # 4. Build Ionic Angular app
      - name: Build Ionic app
        run: npm run build

      # 5. Sync Capacitor with Android
      - name: Sync Capacitor
        run: npx cap sync android

      # 6. Setup Java
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      # Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 7. Decode release keystore
      - name: Decode Keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > $GITHUB_WORKSPACE/release.keystore

      # 8. Update versionCode and versionName in build.gradle
      - name: Update Version
        run: |
          VERSION=${GITHUB_REF_NAME#v}   # e.g. v1.2.3 -> 1.2.3
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          sed -i "s/versionCode [0-9]\\+/versionCode $CODE/" android/app/build.gradle
          sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle
          echo "Using versionCode=$CODE, versionName=$VERSION"

      # 9. Build signed APK
      - name: Build Signed APK
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.RELEASE_KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.RELEASE_KEY_PASSWORD }}

      # 9b. Build signed AAB
      - name: Build Signed AAB
        working-directory: android
        run: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$GITHUB_WORKSPACE/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.RELEASE_KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.RELEASE_KEY_PASSWORD }}

      # 10. Rename outputs with version
      - name: Rename Outputs
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          mv android/app/build/outputs/apk/release/app-release.apk \
            MyMoodLog-$VERSION.apk
          mv android/app/build/outputs/bundle/release/app-release.aab \
            MyMoodLog-$VERSION.aab

      # 11. Upload APK and AAB to GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            MyMoodLog-*.apk
            MyMoodLog-*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. Upload AAB to Google Play
      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.PLAY_STORE_PACKAGE_NAME }}
          releaseFiles: MyMoodLog-${{ env.VERSION }}.aab
          track: internal
          status: completed