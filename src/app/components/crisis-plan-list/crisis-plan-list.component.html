<ion-header>
  <ion-toolbar>
    <ion-title>Crisis Plans</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- ✅ Button at the top -->
  <ion-item lines="none">
    <ion-button expand="block" color="success" (click)="openAddPlan()">
      <ion-icon slot="start" name="add"></ion-icon>
      New Crisis Plan
    </ion-button>
  </ion-item>

  <!-- ✅ List of plans -->
  <ion-list>
    <ion-item *ngFor="let plan of crisisPlans" lines="none">
      <ion-label class="ion-text-wrap">
        <!-- Plan title -->
        <h2>{{ plan.title }}</h2>

        <!-- Reorderable steps -->
        <ion-reorder-group
          [disabled]="false"
          (ionItemReorder)="reorderSteps($event, plan)"
        >
          <ion-item *ngFor="let step of plan.steps; let i = index">
            <ion-label>{{ step }}</ion-label>

            <!-- Edit/Delete buttons -->
            <ion-button
              fill="clear"
              size="small"
              color="primary"
              (click)="openEditStep(plan, i)"
            >
              <ion-icon name="create"></ion-icon>
            </ion-button>
            <ion-button
              fill="clear"
              size="small"
              color="danger"
              (click)="deleteStep(plan, i)"
            >
              <ion-icon name="trash"></ion-icon>
            </ion-button>

            <!-- Drag handle -->
            <ion-reorder slot="end"></ion-reorder>
          </ion-item>
        </ion-reorder-group>

        <!-- Plan-level actions -->
        <div class="plan-actions">
          <ion-button fill="outline" color="primary" (click)="openEditPlan(plan)">
            <ion-icon slot="start" name="create"></ion-icon>
            Edit Plan
          </ion-button>
          <ion-button fill="outline" color="danger" (click)="deletePlan(plan)">
            <ion-icon slot="start" name="trash"></ion-icon>
            Delete Plan
          </ion-button>
          <ion-button color="success" (click)="openAddStep(plan)">
            <ion-icon slot="start" name="add"></ion-icon>
            Add Step
          </ion-button>
        </div>
      </ion-label>
    </ion-item>
  </ion-list>
</ion-content>

<!-- Add Plan Popup -->
<app-custom-text-popup
  #addPlanPopup
  [heading]="'New Crisis Plan'"
  [placeholder]="'Enter crisis plan title'"
  [saveLabel]="'Create'"
  [cancelLabel]="'Cancel'"
  (saved)="handleAddPlan($event)"
></app-custom-text-popup>

<!-- Edit Plan Popup -->
<app-custom-text-popup
  #editPlanPopup
  [heading]="'Edit Plan Title'"
  [placeholder]="'Enter new title'"
  [saveLabel]="'Save'"
  [cancelLabel]="'Cancel'"
  (saved)="handleEditPlan($event)"
></app-custom-text-popup>

<!-- Add/Edit Step Popup -->
<app-custom-text-popup
  #stepPopup
  [heading]="stepPopupHeading"
  [placeholder]="'Enter step'"
  [saveLabel]="stepPopupSaveLabel"
  [cancelLabel]="'Cancel'"
  (saved)="handleStepSave($event)"
></app-custom-text-popup>